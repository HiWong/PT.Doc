# Правильная разработка грамматик для любых формальных языков с помощью ANTLR

Иван Кочуркин

Московский Государственный Технический Университет им Н.Э. Баумана

## Введение

ANTLR - генератор парсеров, поддерживающий LL(*) грамматики. Он существует уже более 20 лет, а в 2013 году вышла его 4-я версия. Сейчас его разработка ведется на GitHub. В данный момент он позволяет генерировать парсеры на языках (рантаймах) Java, C#, Python2, Python3, JavaScript. А в будущем, возможно, появится поддержка C++, Swift и Go.

Несмотря на то, что парсеры на основе ANTLR работают быстро и предсказуемо, а грамматики писать достаточно просто, существуют определенные проблемы, с которыми может столкнуться разработчик парсеров промышленных языков или своего прмедметно-ориентированного языка, DSL. Данная статья освещает эти проблемы. Также в ней описаны способы разработки парсеров для различных гетерогенных формальных языков и описано приложение для удобной работы с различными грамматиками. Теоретические аспекты разработки ANTLR грамматик подкреплены практической реализацией. Автор разработал грамматики PHP, T-SQL, а также сильно улучшил грамматики PL/SQL,  Objective-C и C#. В настоящее время эти грамматики достаточно сильно востребованы как в мире открытого ПО, так и в коммерческой разработке. Грамматики PHP, PL/SQL, T-SQL используются в модуле сигнатурного анализатора кода в продукте [PT Application Inspector](https://www.ptsecurity.com/products/#ai), а Objective-C используется в веб-сервисе по подсчету метрик кода [codebeat](https://hub.codebeat.co/blog/objective-c-support-is-dropping-the-beta-label). На гитхабе по этим грамматикам заведены issues, сделаны pull request в [официальном репозитории](https://github.com/antlr/grammars-v4) ANTLR4, а грамматика PHP используется в открытом проекте для поиска вредоносного PHP кода [mdetect](https://github.com/wsdookadr/mdetect).

## Проблематика парсинга

Одна из проблем парсинга заключается в распознавании ключевых слов как идентификаторов. Например, в C# ключевое слово `async`, помещенное перед сигнатурой метода `async Method()`, означает, что данный метод является асинхронным. Но если данное слово будет использоваться в качестве идентификатора переменной `var async = 42;`, то код также будет валидным.

В естественном языке существуют неоднозначно трактуемые фразы (типа «эти типы стали есть у нас в цеху»). В формальных языках подобные конструкции также могут встречаться. Например, в следующем фрагменте инструкция может быть выражением в одной ситуации и вызовом функции в другой:
```ANTLR
stat: expr ';' // expression statement
    | ID '(' ')' ';' // function call statement;
    ;
expr: ID '(' ')'
    | INT
    ;
```
В ANTLR используются семантические предикаты и другие средства для решения вышеупомянутых проблем.

В процессе парсинга нельзя просто взять и удалить комментарии из исходного кода, поскольку они могут хранить в себе важную информацию, например жестко-заданные пароли или неправильно выровненные строки. Неудобством при обработке комментариев является то, что если включать их в грамматику, то она получится переусложненной, поскольку по сути каждое правило будет содержать в себе подправила с комментариями. ANTLR и другие парсеры исходного кода (Roslyn) имеют различные механизмы по обработке незначимых строк.

Важной способностью каждого парсера является обработка ошибок — по следующим причинам:

* процесс парсинга не должен прерывать только лишь из-за одной ошибки, а должен корректно восстанавливаться и разбирать код дальше (например, после пропущенной точки с запятой);
* поиск релевантной ошибки и ее расположения, вместо множества нерелевантных.

В ANTLR четвертой версии сильно эволюционировала возможность восстановления процесса парсинга после обнаружения синтаксических ошибок, однако иногда лучше немного доработать грамматику, чтобы ошибки обрабатывались еще лучше.

## Виды языков программирования

В настоящее время существует большое количество языков, в которых ключевые слова не чувствительны к регистру, например Basic, Fortran, Pascal и т.п. ANTLR позволяет решить проблему парсинга таких языков с помощью двумя способами: с помощью изменения грамматики и с помощью написания дополнительного кода рантайма.

Существует класс языков, в котором есть этап препроцессинга кода, т.е. предварительной обработки специальных директив, часть из которых используется для проверки, какой настоящий код должен компилироваться, а какой - нет. Это, например, языки семейства C (C#, C++, Objective-C), а также PHP. Одновременно парсить директивы и основной код сложно и некрасиво, так как придется помещать логику обработки прямо в грамматику. Тем не менее в существующих грамматиках PHP, C# и Objective-C данная проблема была решена разными способами, в том числе и таким.

## Оптимизация грамматик и парсеров

В целом парсеры ANTLR имеют отличную производительность практически для любого кода (линейная сложность относительно размера входных данных), за исключением случаев с большим количеством подряд идущих однотипных выражений. Например, конкатенация большого количества строк: `"a" + "a" + ... + "a"`. Оказывается грамматику можно переписать таким образом, чтобы она с одной стороны справлялась с такой глубокой рекурсией а с другой - оставалась достаточно лаконичной и сохраняла прежнюю производительность для всех остальных случаев.

В настоящее время параллелизация и асинхронность является неотемлимой частью как научных, так и повседневных вычислений даже на смартфонах. Процесс парсинга с помощью ANTLR можно распараллелить, однако для достижения максимальной производительности необходимо решить несколько проблем, касающихся использования общего кэша и потребления памяти.

## Новый универсальный редактор грамматик

Для разработки и отладки ANTLR грамматик существует плагины к популярным IDE: ANTLRWorks, ANTLR intellij-plugin-v4, ANTLR Eclipse Plugin. Однако все они обладают определенными недостатками: не позволяют разрабатывать грамматики без IDE и сразу под все рантаймы. Для решения этих проблем было разработано приложение с открытым исходным кодом, [Desktop Antlr Grammar Editor (DAGE)](https://github.com/KvanTTT/DAGE). Оно позволяет полностью проверять грамматику на четырех уровнях:

* проверка корректности синтаксиса грамматики;
* проверка семантики с помощью ANTLR;
* проверка ошибок компиляции сгенерированных файлов;
* непосредственно проверка ошибок парсинга.

Данная декомпозиция этапов проверки с одной стороны позволяет достичь оптимальной скорости работы приложения, а с другой - предоставляет возможность найти все ошибки грамматики с помощью всего лишь одного действия. В ходе разработки потребовалось решить несколько техничеких задач, например, задачу мэппинга текстовых файлов для отоборажения релевантной ошибки компиляции в файле грамматики. Кроме того, одна из главных целей DAGE заключалась в решении проблем парсинга, затронутых в этом тексте. Таким образом, он поддерживает регистронезависимые языки и языки с препроцессингом, а также позволяет проверять корректность грамматик сразу под все рантаймы.

## Заключение

В настоящее время в официальном репозитории существует более 100 грамматик ANTLR. Однако некоторые из них пригодны только для определенных рантаймов, в основном для Java. В перспективе планируется привести все грамматики к универсальному виду, а также разработать веб-версию редактора грамматик Web Antlr Grammar Editor (WAGE) для того, чтобы любой начинающий разработчик парсера DSL или любого другого промышленного языка мог быстро и просто приступить к созданию своей собственной грамматики прямо в браузере, не разбираясь в дополнительных зависимостях. А при желании эту грамматику можно будет сразу расшарить для других более продвинутых пользователей, что позволит им сразу понять, почему парсер работает некорректно.

## Источники

* [Theory and Practice of Source Code Parsing with ANTLR and Roslyn](http://blog.ptsecurity.com/2016/06/theory-and-practice-of-source-code.html)
* Terence Parr, Sam Harwell, Kathleen Fisher. *Adaptive LL(\*) Parsing: The Power of Dynamic Analysis*.
ACM New York, 2014.
* Terence Parr. *The Definitive ANTLR Reference*. Pragmatic Bookshelf, 2013.